<!DOCTYPE html>
<html lang="es">
  <head>
    {% load static %} {% load socialaccount %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoEn</title>

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      href="{% static 'images/faviconTT.png' %}"
    />

    <!-- Fuentes y Bootstrap -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Estilos propios -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  </head>

  <body class="light-mode">
    <!-- Header -->
    <header
      class="text-center p-4 bg-azul d-flex justify-content-between align-items-center"
    >
      <h1 class="m-0">üå± Energ√≠a Renovable</h1>
    </header>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-azul">
      <div class="container-fluid">
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarEcoEn"
          aria-controls="navbarEcoEn"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarEcoEn">
          <ul class="navbar-nav mx-auto">
            <li class="nav-item">
              <a class="nav-link" href="{% url 'index' %}">Inicio</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'productos' %}">Productos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#rese√±as">Rese√±as</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#contacto">Contacto</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Contenido din√°mico -->
    <main>{% block content %} {% endblock %}</main>

    <!-- Bot√≥n flotante -->
    <div id="menu-toggle" onclick="toggleMenu()" class="menu-toggle">
      <span id="menu-icon">
        {% if user.is_authenticated %} üë§ {{ user.username }} {% else %} ‚ò∞
        {%endif %}
      </span>
    </div>

    <!-- Men√∫ lateral -->
    <div id="menu-lateral" class="menu-lateral">
      <span class="close-btn" onclick="toggleMenu()">‚úñ</span>

      {% if user.is_authenticated %}
      <p class="menu-header">üëã Hola, {{ user.username }}</p>
      <a href="{% url 'logout' %}" class="btn btn-danger w-100 mt-3"
        >Cerrar sesi√≥n</a
      >
      {% else %}
      <button onclick="toggleLoginOptions()" class="btn btn-primary w-100 mb-3">
        üîê Iniciar sesi√≥n
      </button>
      <div id="login-options" style="display: none; margin-top: 10px">
        <a href="{% url 'login' %}" class="btn btn-outline-primary w-100 mb-2"
          >Iniciar sesi√≥n con usuario</a
        >
        <a
          href="{% provider_login_url 'google' %}"
          class="btn btn-outline-danger w-100 mb-2"
          >Iniciar sesi√≥n con Google</a
        >
        <p class="text-center mt-3">
          ¬øNo tienes una cuenta?
          <a href="{% url 'registro' %}" class="text-success"
            >Reg√≠strate aqu√≠</a
          >
        </p>
      </div>
      {% endif %}

      <a
        href="{% url 'mi_perfil' %}"
        class="btn btn-outline-secondary w-100 mt-3"
        >üë§ Ver perfil</a
      >

      <button onclick="toggleConfig()" class="btn btn-secondary w-100 mt-4">
        ‚öôÔ∏è Configuraci√≥n
      </button>
      <div id="config-options" style="display: none" class="mt-2">
        <button onclick="toggleDarkMode()" class="btn btn-dark w-100">
          üåô Modo oscuro / claro
        </button>
      </div>
    </div>
     
  <!-- Bot√≥n flotante con mascotita -->
<div id="chatbot-button">
  <img src="{% static 'img/ecobot.png' %}" alt="EcoBot" style="width:40px;height:40px;">
</div>

<!-- Ventana del chatbot -->
<div id="chatbot-window">
  <div id="chatbot-header">üå± EcoBot</div>
  <div id="chatbot-messages"></div>
  <div id="chatbot-input">
    <input type="text" id="userMessage" placeholder="Escribe tu mensaje...">
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>

<link rel="stylesheet" href="{% static 'css/chatbot.css' %}">
<script src="{% static 'js/chatbot.js' %}"></script>


    <!-- Scripts -->
    <script>
      function toggleMenu() {
        document.getElementById("menu-lateral").classList.toggle("active");
      }

      function toggleLoginOptions() {
        const login = document.getElementById("login-options");
        login.style.display = login.style.display === "none" ? "block" : "none";
      }

      function toggleConfig() {
        const config = document.getElementById("config-options");
        config.style.display =
          config.style.display === "none" ? "block" : "none";
      }

      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
      }

      const TASA_PESO = 950;
      let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

      function guardarCarrito() {
        localStorage.setItem("carrito", JSON.stringify(carrito));
      }

      function actualizarCarrito() {
        const lista = document.getElementById("carrito-lista");
        const totalElemento = document.getElementById("carrito-total");
        if (!lista || !totalElemento) return;

        lista.innerHTML = "";
        let total = 0;

        carrito.forEach((item, index) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `${item.producto} - $${item.precioARS.toLocaleString(
            "es-AR"
          )} ARS
          <button class="btn btn-sm btn-danger" onclick="eliminarItem(${index})">üóë</button>`;
          lista.appendChild(li);
          total += item.precioARS;
        });

        totalElemento.textContent = total.toLocaleString("es-AR");
        guardarCarrito();

        const metodos = document.getElementById("metodos-pago");
        if (metodos) {
          metodos.classList.toggle("d-none", carrito.length === 0);
        }
      }

      function eliminarItem(index) {
        carrito.splice(index, 1);
        actualizarCarrito();
      }

      document.addEventListener("DOMContentLoaded", () => {
        actualizarCarrito();

        document.querySelectorAll(".add-to-cart").forEach((boton) => {
          boton.addEventListener("click", () => {
            const producto = boton.dataset.product;
            const precioUSD = parseFloat(boton.dataset.price);
            const precioARS = precioUSD * TASA_PESO;

            carrito.push({ producto, precioARS });
            actualizarCarrito();
            alert(`${producto} agregado al carrito üõí`);
          });
        });

        const btnComprar = document.getElementById("btn-comprar");
        if (btnComprar) {
          btnComprar.addEventListener("click", () => {
            if (carrito.length === 0) {
              alert("El carrito est√° vac√≠o.");
              return;
            }
            document.getElementById("metodos-pago").classList.remove("d-none");
          });
        }

        document
          .querySelectorAll('input[name="metodoPago"]')
          .forEach((radio) => {
            radio.addEventListener("change", () => {
              const transferencia =
                document.getElementById("pagoTransferencia").checked;
              document
                .getElementById("datos-transferencia")
                .classList.toggle("d-none", !transferencia);
            });
          });

        const btnConfirmar = document.getElementById("btn-confirmar");
        if (btnConfirmar) {
          btnConfirmar.addEventListener("click", () => {
            const metodo = document.querySelector(
              'input[name="metodoPago"]:checked'
            );
            if (!metodo) {
              alert("Seleccion√° un m√©todo de pago.");
              return;
            }

            alert(`Compra confirmada con ${metodo.value}. ¬°Gracias!`);
            carrito = [];
            actualizarCarrito();
            document.getElementById("metodos-pago").classList.add("d-none");
          });
        }
      });
       document.getElementById("chatbot-button").onclick = function() {
      const chatWindow = document.getElementById("chatbot-window");
      chatWindow.style.display = chatWindow.style.display === "none" ? "block" : "none";
    };

    async function sendMessage() {
      const message = document.getElementById("userMessage").value;
      const response = await fetch("/chat/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message})
      });
      const data = await response.json();

      const chatLog = document.getElementById("chatbot-messages");
      chatLog.innerHTML += `<p><b>T√∫:</b> ${message}</p>`;
      chatLog.innerHTML += `<p><b>EcoBot:</b> ${data.reply}</p>`;
      document.getElementById("userMessage").value = "";
    }
    </script>

  </body>
</html>
